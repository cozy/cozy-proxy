// Generated by CoffeeScript 1.10.0
var User, otpManager, passport, passwordKeys, qs, url;

passport = require('passport');

qs = require('querystring');

passwordKeys = require('../lib/password_keys');

otpManager = require('../lib/2fa_manager');

url = require('url');

User = require('../models/user');

module.exports.authenticate = function(req, res, next) {
  var postLogin, process, processOtp;
  process = function(err, user) {
    var error;
    if (err) {
      error = new Error('error server');
      return next(error);
    } else if (user === void 0 || !user) {
      error = new Error('error bad credentials');
      error.status = 401;
      return next(error);
    } else {
      return passwordKeys.initializeKeys(req.body.password, function(err) {
        if (err) {
          error = new Error('error keys not intialized');
          return next(error);
        } else {
          return postLogin(user);
        }
      });
    }
  };
  postLogin = function(user) {
    return otpManager.getAuthType(function(err, otpAuth) {
      var error;
      if (err) {
        error = new Error('error login failed');
        error.status = 401;
        return next(error);
      } else if (!otpAuth) {
        return req.logIn(user, function(err, info) {
          if (err) {
            error = new Error('error login failed');
            error.status = 401;
            return next(error);
          } else {
            return res.status(200).send({
              success: true
            });
          }
        });
      } else {
        return passport.authenticate(otpAuth, processOtp)(req, res, next);
      }
    });
  };
  processOtp = function(err, user) {
    var error;
    if (err) {
      error = new Error(err);
      return next(error);
    } else if (!user && user !== void 0) {
      error = new Error('error otp invalid code');
      error.status = 401;
      return next(error);
    } else {
      return User.first(function(err, user) {
        return req.logIn(user, function(err, info) {
          if (err) {
            error = new Error('error login failed');
            error.status = 401;
            return next(error);
          } else {
            return res.status(200).send({
              success: true
            });
          }
        });
      });
    }
  };
  return passport.authenticate('local', process)(req, res, next);
};

module.exports.isAuthenticated = function(req, res, next) {
  if (req.isAuthenticated()) {
    return next();
  } else {
    url = "/login";
    if (req.url !== '/') {
      url += "?next=" + (encodeURIComponent(req.url));
    }
    if (req.query.length) {
      url += "&" + (qs.stringify(req.query));
    }
    return res.redirect(url);
  }
};

module.exports.isNotAuthenticated = function(req, res, next) {
  if (req.isAuthenticated()) {
    return res.redirect('/');
  } else {
    return next();
  }
};
