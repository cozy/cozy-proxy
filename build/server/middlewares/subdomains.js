// Generated by CoffeeScript 1.9.1
var application, cozyInstance, path;

path = require('path');

cozyInstance = require(path.join(__dirname, '../models/instance'));

application = require(path.join(__dirname, '../models/application'));

module.exports = function(req, res, next) {
  return cozyInstance.getDomain(function(err, domain) {
    var hostname;
    if (!domain) {
      return next();
    }
    if (!(domain === req.headers.host)) {
      hostname = req.headers.host.split(':')[0];
      return application.domainSlug(hostname, function(err, appSlug) {
        if (!(appSlug === "")) {
          if (!(req.url.indexOf("/public") > -1)) {
            req.url = "/public/" + appSlug + req.url;
          }
        }
        return next();
      });
    } else {
      return next();
    }
  });
};
