// Generated by CoffeeScript 1.10.0
var JsonClient, StatusChecker, User, async, controllerHost, controllerPort, controllerUrl, couchUrl, couchdbHost, couchdbPort, dataSystemHost, dataSystemPort, dataSystemUrl, homeHost, homePort, homeUrl, proxyHost, proxyPort, proxyUrl;

async = require('async');

JsonClient = require('request-json').JsonClient;

User = require('../models/user');

couchdbHost = process.env.COUCH_HOST || 'localhost';

couchdbPort = process.env.COUCH_PORT || '5984';

proxyHost = process.env.PROXY_HOST || 'localhost';

proxyPort = process.env.PROXY_PORT || '9104';

controllerHost = process.env.CONTROLLER_HOST || 'localhost';

controllerPort = process.env.CONTROLLER_PORT || '9002';

dataSystemHost = process.env.DATASYSTEM_HOST || 'localhost';

dataSystemPort = process.env.DATASYSTEM_PORT || '9101';

homeHost = process.env.HOME_HOST || 'localhost';

homePort = process.env.DEFAULT_REDIRECT_PORT;

couchUrl = "http://" + couchdbHost + ":" + couchdbPort + "/";

controllerUrl = "http://" + controllerHost + ":" + controllerPort + "/";

dataSystemUrl = "http://" + dataSystemHost + ":" + dataSystemPort + "/";

homeUrl = "http://" + homeHost + ":" + homePort + "/";

proxyUrl = "http://" + proxyHost + ":" + proxyPort + "/";

StatusChecker = (function() {
  function StatusChecker() {}

  StatusChecker.prototype.client = new JsonClient();

  StatusChecker.prototype.status = {
    couchdb: false,
    datasystem: false,
    controller: false,
    home: false,
    registered: false
  };

  StatusChecker.prototype.checkAllStatus = function(callback) {
    var field, ref, value;
    ref = this.status;
    for (field in ref) {
      value = ref[field];
      this.status[field] = false;
    }
    return async.series([this.getChecker("couchdb", couchUrl), this.getChecker("controller", controllerUrl), this.getChecker("datasystem", dataSystemUrl), this.getChecker("home", homeUrl), this.getChecker("proxy", proxyUrl, "routes")], (function(_this) {
      return function() {
        return User.first(function(err, user) {
          if ((user == null) || err) {
            return callback(null, _this.status);
          } else {
            _this.status.registered = true;
            return callback(null, _this.status);
          }
        });
      };
    })(this));
  };

  StatusChecker.prototype.getChecker = function(app, url, path) {
    if (path == null) {
      path = "";
    }
    return (function(_this) {
      return function(callback) {
        _this.client.host = url;
        return _this.client.get(path, function(err, res, body) {
          var code;
          if (res != null) {
            code = res.statusCode;
            _this.status[app] = code === 200 || code === 401 || code === 403;
          } else {
            _this.status[app] = false;
          }
          return callback();
        }, false);
      };
    })(this);
  };

  return StatusChecker;

})();

module.exports = new StatusChecker();
