// Generated by CoffeeScript 1.10.0
var americano, authSteps, config, cookieParser, cookieSession, fs, locales, passport, path, randomstring, selectiveBodyParser, useBuildView;

fs = require('fs');

path = require('path');

americano = require('americano');

cookieParser = require('cookie-parser');

cookieSession = require('cookie-session');

passport = require('passport');

randomstring = require('randomstring');

selectiveBodyParser = require('./middlewares/selective_body_parser');

authSteps = [
  cookieParser(randomstring.generate()), cookieSession({
    secret: randomstring.generate(),
    maxage: 1000 * 60 * 60 * 24 * 7,
    secureProxy: process.env.NODE_ENV === 'production'
  }), passport.initialize(), passport.session()
];

useBuildView = fs.existsSync(path.resolve(__dirname, 'views/index.js'));

locales = fs.readdirSync(path.join(__dirname, 'locales')).map(function(file) {
  return path.basename(file, '.json');
});

config = {
  authSteps: authSteps,
  supportedLanguages: locales,
  common: {
    use: [
      americano.errorHandler({
        dumpExceptions: true,
        showStack: true
      }), americano["static"](path.join(__dirname, '../client/public')), selectiveBodyParser, authSteps[0], authSteps[1], authSteps[2], authSteps[3]
    ],
    set: {
      'view engine': useBuildView ? 'js' : 'jade',
      'views': path.resolve(__dirname, 'views')
    },
    engine: {
      js: function(path, locales, callback) {
        return callback(null, require(path)(locales));
      }
    }
  },
  development: [americano.logger('dev')],
  production: [americano.logger('short')],
  plugins: ['cozydb']
};

module.exports = config;
